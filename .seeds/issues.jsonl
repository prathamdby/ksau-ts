{"id":"ksau-ts-eda2","title":"Project scaffolding and build system","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T07:47:11.814Z","updatedAt":"2026-03-01T08:39:17.588Z","description":"Initialize ksau-ts project: package.json, tsconfig.json, Makefile, .gitignore, .github/workflows/release.yml. Covers US-001, US-022, US-023 from SPEC.md. Must be done first as all other work streams depend on it.","closedAt":"2026-03-01T08:39:17.588Z"}
{"id":"ksau-ts-24a3","title":"Port azure/ and crypto/ modules","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T07:47:17.473Z","updatedAt":"2026-03-01T08:39:17.636Z","description":"Port all files under src/azure/ and src/crypto/: constants.ts, types.ts, item.ts, config.ts, client.ts, quota.ts, hash.ts, upload.ts, crypto/quickxorhash.ts, crypto/placeholder.ts, crypto/algo.ts. Covers US-002 through US-011 from SPEC.md. Depends on scaffolding being complete.","closedAt":"2026-03-01T08:39:17.636Z","closeReason":"Ported all 11 azure/ and crypto/ source files (US-002 through US-011). AzureClient with promise-mutex token refresh, faithful QuickXorHash port, openpgp v6 decrypt/encrypt, bigint byte counts throughout. Typecheck passes. 7 commits on branch overstory/azure-crypto-builder/ksau-ts-24a3."}
{"id":"ksau-ts-2996","title":"Port cmd/ layer and entry point","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T07:47:22.282Z","updatedAt":"2026-03-01T08:39:17.683Z","description":"Port all files under src/cmd/: root.ts, upload.ts, quota.ts, refresh.ts, listRemotes.ts, version.ts, help.ts, utils.ts, progress/progress.ts, and src/main.ts. Covers US-012 through US-021 from SPEC.md. Depends on azure/ and crypto/ modules being complete.","closedAt":"2026-03-01T08:39:17.683Z","closeReason":"Ported all 10 cmd/ files and src/main.ts (US-012 through US-021). Builder cmd-builder committed on branch overstory/cmd-builder/ksau-ts-2996 (commit 20e862a). All acceptance criteria satisfied: progress tracker with 5 styles, utils with config/chunking/remote selection/integrity verification, root/version/refresh/listRemotes/quota/help/upload commands, full main.ts wiring."}
{"id":"ksau-ts-4968","title":"Fix build script missing --target bun","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T08:43:31.302Z","updatedAt":"2026-03-01T08:49:21.631Z","description":"package.json 'build' script uses 'bun build' without '--target bun', causing browser polyfill errors for node:os and other Node builtins. Fix: add '--target bun' to the build script in package.json. One-line change.","closedAt":"2026-03-01T08:49:21.631Z","closeReason":"Added --target bun to package.json build script to fix node:os browser polyfill errors"}
{"id":"ksau-ts-7e89","title":"Fix AzureClient missing methods and KibiByte type","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T08:50:04.504Z","updatedAt":"2026-03-01T09:02:24.806Z","description":"Two typecheck fixes: (1) src/azure/constants.ts KibiByte=1024 must be 1024n (bigint) -- causes bigint*number errors in utils.ts and upload.ts. (2) src/azure/client.ts is missing getDriveQuota(), upload(), getQuickXorHash() instance methods -- cmd/ layer calls these as class methods but azure/ builder implemented them as standalone functions. Add delegate instance methods to AzureClient that call the standalone functions.","closedAt":"2026-03-01T09:02:24.806Z","closeReason":"Fixed KibiByte to bigint literal (1024n) and added three delegation methods (getDriveQuota, upload, getQuickXorHash) to AzureClient class. TypeScript compilation passes."}
{"id":"ksau-ts-c239","title":"Fix placeholder.ts dev fallback for missing assets","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T09:04:22.474Z","updatedAt":"2026-03-01T09:14:00.719Z","description":"Bun.embeddedFiles is empty in non-compiled builds (bun run / bun build without --compile). placeholder.ts crashes at startup with 'undefined is not an object'. Fix: fall back to reading src/crypto/privkey.pem and src/crypto/passphrase.txt from disk when embeddedFiles does not contain the keys. SPEC states: Bun.embeddedFiles falls back to reading the asset path on disk in dev mode.","closedAt":"2026-03-01T09:14:00.719Z","closeReason":"Fixed placeholder.ts dev fallback: check embeddedFiles existence before access, fall back to readFileSync for non-compiled builds. Fixed package.json build script to bun run src/main.ts. bunx tsc --noEmit exits 0."}
{"id":"ksau-ts-0fe9","title":"Fix package.json build script for dev compile","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T09:16:05.000Z","updatedAt":"2026-03-01T09:29:43.523Z","description":"The build script was set to 'bun run src/main.ts' which just runs the CLI. Per SPEC US-022, scripts.build should produce a local dev binary without assets. Fix: set to 'bun build src/main.ts --target bun --compile --outfile ksau-ts-dev'. The --compile flag makes it a real executable. placeholder.ts already handles the missing-assets case via readFileSync fallback.","closedAt":"2026-03-01T09:29:43.523Z"}
{"id":"ksau-ts-7021","title":"Fix placeholder.ts path resolution for compiled binaries","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T09:32:06.716Z","updatedAt":"2026-03-01T09:43:36.046Z","description":"In a bun --compile binary, import.meta.dir resolves to //root, not the project directory. placeholder.ts tries to read privkey.pem from that virtual path and fails. Fix: when embeddedFiles is empty, resolve paths relative to process.cwd() instead of import.meta.dir. This allows the dev binary to find the crypto files in the current working directory (where the user runs the binary from).","closedAt":"2026-03-01T09:43:36.046Z","closeReason":"Fixed placeholder.ts: coordinator's builder committed process.cwd() fallback fix. import.meta.dir → process.cwd() when embeddedFiles absent. Merged to main as cba642b."}
{"id":"ksau-ts-1d62","title":"Fix placeholder.ts use process.cwd() fallback","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T09:33:52.954Z","updatedAt":"2026-03-01T09:43:41.473Z","closedAt":"2026-03-01T09:43:41.473Z","closeReason":"Builder worktree had correct file; coordinator merged via separate builder."}
{"id":"ksau-ts-ae9c","title":"Commit placeholder.ts fix and close","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T09:38:14.568Z","updatedAt":"2026-03-01T09:43:41.515Z","closedAt":"2026-03-01T09:43:41.515Z","closeReason":"Stale worktree, superseded by coordinator direct build."}
{"id":"ksau-ts-dbe4","title":"Commit: placeholder.ts fix in builder worktree","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T09:40:41.385Z","updatedAt":"2026-03-01T09:43:41.556Z","closedAt":"2026-03-01T09:43:41.556Z","closeReason":"Stale worktree, superseded by coordinator direct build."}
{"id":"ksau-ts-51e5","title":"Suppress OpenPGP.js debug output in decrypt","status":"closed","type":"task","priority":2,"createdAt":"2026-03-01T09:45:38.762Z","updatedAt":"2026-03-01T09:59:07.942Z","description":"OpenPGP.js is emitting debug stack traces to stderr during decrypt operations. The errors don't affect functionality (decryption succeeds for valid sections) but the noise is poor UX. Fix: wrap decrypt in try-catch to suppress error output, or configure openpgp to disable debug mode. The decrypt function in src/crypto/algo.ts should not leak internal library debug info to the user.","closedAt":"2026-03-01T09:59:07.942Z","closeReason":"Suppress OpenPGP.js console.error debug noise during decrypt via console.error no-op guard in try/finally"}
{"id":"ksau-ts-b69e","title":"Stream file chunks on-demand instead of readFileSync in upload.ts","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T15:44:53.773Z","updatedAt":"2026-03-01T16:09:54.174Z","description":"upload() in src/azure/upload.ts calls readFileSync(params.filePath) at line 15, loading the entire file into memory before any chunk is sent. For large files (e.g. 2GB) this allocates 2GB of RAM upfront. Fix: replace readFileSync with Bun.file().slice(start, end+1) so each chunk is read on-demand. The chunk loop already has start/end bigints available — use them to slice the Bun.file handle directly. Also update uploadChunk signature to accept Uint8Array | ReadableStream as appropriate. Acceptance: upload.ts no longer imports or calls readFileSync; chunk reads are lazy/on-demand.","closedAt":"2026-03-01T16:09:54.174Z","closeReason":"Replaced readFileSync with Bun.file().slice in upload.ts for on-demand lazy chunk reads. uploadChunk now accepts Uint8Array | Blob. Typecheck passes zero errors. Branch: overstory/stream-upload-builder/ksau-ts-b69e."}
{"id":"ksau-ts-2b58","title":"Make AzureClient.fromRcloneConfigData async and call ensureTokenValid on construction","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T15:44:59.935Z","updatedAt":"2026-03-01T16:08:59.481Z","description":"AzureClient.fromRcloneConfigData in src/azure/client.ts is synchronous. If the token stored in rclone.conf is already expired at config-load time, the first API call may use a stale accessToken on any code path that doesn't independently call ensureTokenValid(). Fix: make fromRcloneConfigData async, call this.ensureTokenValid() before returning the new AzureClient instance. Update all three call sites: src/azure/client.ts selectRemoteAutomatically, src/cmd/upload.ts, and src/cmd/utils.ts. Acceptance: fromRcloneConfigData is async, awaits ensureTokenValid(), all call sites await it.","closedAt":"2026-03-01T16:08:59.481Z","closeReason":"Made AzureClient.fromRcloneConfigData async; calls ensureTokenValid() before returning. All call sites already awaited the method. bun run typecheck passes."}
{"id":"ksau-ts-1462","title":"Re-validate token before each chunk upload to handle mid-upload expiry","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T15:45:06.246Z","updatedAt":"2026-03-01T16:18:54.902Z","description":"upload() in src/azure/upload.ts calls client.ensureTokenValid() once at the top of the function but never again. For large files, an upload can span longer than the token lifetime (~1 hour). createUploadSession and getFileID use client.accessToken directly without refreshing. Fix: call await client.ensureTokenValid() at the start of the chunk retry loop (before each fetch in uploadChunk, or pass client into uploadChunk and call it there). Also call ensureTokenValid() at the start of createUploadSession and getFileID. Acceptance: ensureTokenValid is called before every outbound authenticated fetch in upload.ts.","closedAt":"2026-03-01T16:18:54.902Z"}
{"id":"ksau-ts-f63c","title":"Fix getRemoteConfig in config.ts — iterates keys instead of checking remote_name value","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T15:45:12.708Z","updatedAt":"2026-03-01T16:13:29.903Z","description":"getRemoteConfig in src/azure/config.ts has a broken lookup loop: it iterates elem.keys() and compares each key string to remoteName, but remote names are stored as values under the key 'remote_name', not as map keys. The correct check is elem.get('remote_name') === remoteName. The function is currently dead code (not called), but it will silently return wrong data or throw if called. Fix: replace the inner for-of loop over elem.keys() with a direct elem.get('remote_name') === remoteName check, mirroring the correct pattern already used in fromRcloneConfigData. Acceptance: getRemoteConfig finds the right config map using the remote_name value.","closedAt":"2026-03-01T16:13:29.903Z","closeReason":"Fixed getRemoteConfig in azure/config.ts: inner loop iterated map keys instead of checking remote_name value. Changed to elem.get('remote_name') === remoteName. bun run typecheck passes."}
{"id":"ksau-ts-fa84","title":"Replace path.join with posix path joins for OneDrive remote paths","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T15:45:19.643Z","updatedAt":"2026-03-01T16:14:51.637Z","description":"src/cmd/upload.ts uses path.join for remoteFilePath and fullRemotePath construction. On Windows, path.join produces backslash-separated paths (e.g. folder\\file.txt) which are invalid for OneDrive Graph API URLs. Fix: replace all path.join calls that construct remote (OneDrive) paths with path.posix.join — specifically the remoteFilePath assignments (lines ~130-132) and fullRemotePath (line ~135). The urlPath construction already has a .replace(/\\\\/g, '/') workaround — remove that workaround once path.posix.join is used. Local filesystem paths (path.basename, statSync) should remain as path.*. Acceptance: all OneDrive remote path construction uses path.posix.join; no manual backslash-replace needed.","closedAt":"2026-03-01T16:14:51.637Z","closeReason":"Replaced path.join with path.posix.join for all OneDrive remote path construction in src/cmd/upload.ts. Removed backslash workaround in urlPath. Typecheck passes."}
{"id":"ksau-ts-d76d","title":"Make fromRcloneConfigData async and call ensureTokenValid on construction","status":"in_progress","type":"task","priority":1,"createdAt":"2026-03-01T16:32:36.203Z","updatedAt":"2026-03-01T16:34:28.243Z","description":"AzureClient.fromRcloneConfigData is still sync. If token is expired at config load, first API call can fail on paths that don't call ensureTokenValid(). Make it async, call ensureTokenValid() before returning. Update call sites to await."}
{"id":"ksau-ts-910d","title":"Add try/catch for getConfigData in quota command","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T16:32:36.881Z","updatedAt":"2026-03-01T16:40:21.622Z","description":"Quota command has no error handling on getConfigData(). Add try/catch and surface user-friendly error.","closedAt":"2026-03-01T16:40:21.622Z"}
{"id":"ksau-ts-a868","title":"Replace console.error suppression hack in algo.ts","status":"closed","type":"task","priority":2,"createdAt":"2026-03-01T16:32:37.525Z","updatedAt":"2026-03-01T16:38:15.470Z","description":"OpenPGP decrypt still uses a console.error suppression hack. Replace with proper config or try/catch so library debug output is not leaked.","closedAt":"2026-03-01T16:38:15.470Z","closeReason":"Removed console.error suppression hack from decrypt(): deleted monkey-patching and try/finally wrapper, replaced with direct openpgp.decrypt() call. Typecheck passes."}
{"id":"ksau-ts-9ae2","title":"Smooth speed calculation with rolling average","status":"in_progress","type":"task","priority":2,"createdAt":"2026-03-01T16:32:37.943Z","updatedAt":"2026-03-01T16:34:40.314Z","description":"Progress speed is instantaneous and jumpy. Use a rolling average (e.g. last N samples or time window) for stable display."}
{"id":"ksau-ts-8b3e","title":"Guard basicStyle negative repeat to avoid crash","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T16:32:43.635Z","updatedAt":"2026-03-01T16:39:23.355Z","description":"basicStyle (progress) with negative repeat is unguarded and can crash. Add guard so negative repeat is safe.","closedAt":"2026-03-01T16:39:23.355Z"}
{"id":"ksau-ts-277c","title":"Add AbortSignal.timeout on upload chunk fetches","status":"closed","type":"task","priority":1,"createdAt":"2026-03-01T16:32:44.419Z","updatedAt":"2026-03-01T16:38:59.556Z","description":"Upload chunk PUT requests have no timeout. Use AbortSignal.timeout(ms) so long-hanging requests fail instead of hanging indefinitely.","closedAt":"2026-03-01T16:38:59.556Z"}
{"id":"ksau-ts-1e17","title":"Replace Promise.race timeout in selectRemoteAutomatically","status":"in_progress","type":"task","priority":2,"createdAt":"2026-03-01T16:32:45.107Z","updatedAt":"2026-03-01T16:34:55.725Z","description":"selectRemoteAutomatically uses Promise.race + event listener for timeout. Replace with AbortSignal.timeout or cleaner pattern."}
{"id":"ksau-ts-cfd2","title":"Polish: lint script, docs, small UX/config cleanups","status":"closed","type":"task","priority":2,"createdAt":"2026-03-01T16:32:46.704Z","updatedAt":"2026-03-01T16:56:52.648Z","description":"Items 12-20: Add lint script to package.json, docs/README tweaks, any small UX or config cleanups identified during review.","closedAt":"2026-03-01T16:56:52.648Z","closeReason":"Polish batch complete: lint script (biome), README.md, biome.json config, code quality fixes (typed quota, Number.isNaN, template literals, import type), wired --hash-retries/--hash-retry-delay CLI flags, placeholder test. All quality gates pass on builder-polish branch."}
